import{r as e,u as t,j as l}from"./useTranslation-e596755c.js";import{x as i,y as r,ad as n,aD as a,aS as o,ai as s,ae as d,ah as c}from"./RecordCard-cc8b414d.js";import{a8 as p}from"./utils-e6894fde.js";import{s as u}from"./styled-components.browser.esm-f2eded25.js";import{A as m,_ as y,bi as b,bj as h,bk as k,bl as x,P as g,W as j}from"./ImportReducerContext-32a848c6.js";import{S as v,T as f}from"./index-4c873b97.js";import"./asyncToGenerator-2132afe6.js";const L={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M608 112c-167.9 0-304 136.1-304 304 0 70.3 23.9 135 63.9 186.5l-41.1 41.1-62.3-62.3a8.15 8.15 0 00-11.4 0l-39.8 39.8a8.15 8.15 0 000 11.4l62.3 62.3-44.9 44.9-62.3-62.3a8.15 8.15 0 00-11.4 0l-39.8 39.8a8.15 8.15 0 000 11.4l62.3 62.3-65.3 65.3a8.03 8.03 0 000 11.3l42.3 42.3c3.1 3.1 8.2 3.1 11.3 0l253.6-253.6A304.06 304.06 0 00608 720c167.9 0 304-136.1 304-304S775.9 112 608 112zm161.2 465.2C726.2 620.3 668.9 644 608 644c-60.9 0-118.2-23.7-161.2-66.8-43.1-43-66.8-100.3-66.8-161.2 0-60.9 23.7-118.2 66.8-161.2 43-43.1 100.3-66.8 161.2-66.8 60.9 0 118.2 23.7 161.2 66.8 43.1 43 66.8 100.3 66.8 161.2 0 60.9-23.7 118.2-66.8 161.2z"}}]},name:"key",theme:"outlined"};var I=function(t,l){return e.createElement(m,y(y({},t),{},{ref:l,icon:L}))};I.displayName="KeyOutlined";const _=e.forwardRef(I);const C={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M574 665.4a8.03 8.03 0 00-11.3 0L446.5 781.6c-53.8 53.8-144.6 59.5-204 0-59.5-59.5-53.8-150.2 0-204l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3l-39.8-39.8a8.03 8.03 0 00-11.3 0L191.4 526.5c-84.6 84.6-84.6 221.5 0 306s221.5 84.6 306 0l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3L574 665.4zm258.6-474c-84.6-84.6-221.5-84.6-306 0L410.3 307.6a8.03 8.03 0 000 11.3l39.7 39.7c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c53.8-53.8 144.6-59.5 204 0 59.5 59.5 53.8 150.2 0 204L665.3 562.6a8.03 8.03 0 000 11.3l39.8 39.8c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c84.5-84.6 84.5-221.5 0-306.1zM610.1 372.3a8.03 8.03 0 00-11.3 0L372.3 598.7a8.03 8.03 0 000 11.3l39.6 39.6c3.1 3.1 8.2 3.1 11.3 0l226.4-226.4c3.1-3.1 3.1-8.2 0-11.3l-39.5-39.6z"}}]},name:"link",theme:"outlined"};var T=function(t,l){return e.createElement(m,y(y({},t),{},{ref:l,icon:C}))};T.displayName="LinkOutlined";const A=e.forwardRef(T),w=u.div`
    display: grid;
    grid-template-columns: 7rem 3rem;
    grid-column-gap: 0.5em;
    grid-row-gap: 1em;
`;function S({columnIndex:e,sheet:i,onChange:r}){const{t:n}=t(),a=i.type===b.LINK,o=a||i.mode!==h.insert,s=a;return o||s?l.jsxs(w,{hasKeyTo:a,children:[o&&l.jsxs(l.Fragment,{children:[l.jsxs("label",{children:[n("import.import_key"),": "]}),l.jsx(v,{checked:i.keyColumnIndex===e,onChange:e=>{r("key",e)}})]}),s&&l.jsxs(l.Fragment,{children:[l.jsxs("label",{children:[n("import.link_key"),": "]}),l.jsx(v,{checked:i.keyToColumnIndex===e,onChange:e=>{r("keyTo",e)}})]})]}):null}const O=u(r)`
    font-weight: bold;
    margin: 0.5em 0;
    color: ${i.errorColor};
`;function E({sheet:e}){var i;const{state:n}=k(),{t:a}=t(),o=(null==(i=null==n?void 0:n.settingsError)?void 0:i[e.name])??[],s=[x.MAPPING,x.KEY,x.KEY_TO];return l.jsxs(r,{direction:"vertical",children:[a("import.mapping"),l.jsx(O,{direction:"vertical",size:"small",children:s.map((e=>o.includes(e)?a(`import.settings_errors.${e}`):null))})]})}const N=e=>e.type===g.simple_link||e.type===g.advanced_link||e.type===g.tree,K=u(r)`
    && .ant-form-item-label {
        padding: 0;
        font-weight: bold;
    }
`;function z({sheetIndex:e,libraries:i,onLibrarySelect:r,onImportTypeSelect:s,onImportModeSelect:d,onLinkAttributeSelect:c,onTreeLinkLibrarySelect:u}){var m,y,x,j;const{lang:v}=n(),{t:f}=t(),{state:L}=k(),I=L.sheets[e],_=I.type===b.IGNORE,C=I.type===b.LINK&&(null==(m=I.linkAttributeProps)?void 0:m.type)===g.tree?((null==(x=null==(y=I.linkAttributeProps)?void 0:y.linked_tree)?void 0:x.libraries)??[]).map((e=>({key:e.library.id,value:e.library.id,label:p(e.library.label,v)}))):null;return l.jsx(a,{layout:"vertical",children:l.jsxs(K,{direction:"horizontal",size:"middle",wrap:!0,children:[l.jsx(a.Item,{label:f("import.type"),required:!0,children:l.jsx(o,{style:{minWidth:200},defaultValue:I.type,placeholder:f("import.select_type"),onChange:t=>s(e,t),children:Object.values(b).map((e=>l.jsx(o.Option,{value:e,children:f(`import.types.${e}`)},e)))})}),!_&&l.jsxs(l.Fragment,{children:[l.jsx(a.Item,{label:f("import.mode"),required:!0,children:l.jsx(o,{style:{minWidth:240},defaultValue:I.mode,placeholder:f("import.select_mode"),onChange:t=>d(e,t),children:Object.values(h).map((e=>l.jsx(o.Option,{value:e,children:f(`import.modes.${e}`)},e)))})}),l.jsx(a.Item,{label:f("import.library"),required:!0,children:l.jsx(o,{style:{minWidth:200},defaultValue:I.library??L.defaultLibrary,placeholder:f("import.select_library"),onChange:t=>r(e,t),children:i.map((e=>l.jsx(o.Option,{value:e.id,children:p(e.label,v)||e.id},e.id)))})}),I.type===b.LINK&&I.library&&l.jsx(a.Item,{label:f("import.link_attribute"),required:!0,children:l.jsx(o,{style:{minWidth:200},defaultValue:I.linkAttribute,value:I.linkAttribute,placeholder:f("import.select_link_attribute"),onChange:t=>c(e,t),children:I.attributes.filter(N).map((e=>l.jsx(o.Option,{value:e.id,children:p(e.label,v)||e.id},e.id)))})}),I.type===b.LINK&&(null==(j=I.linkAttributeProps)?void 0:j.type)===g.tree&&l.jsx(a.Item,{label:f("import.tree_link_library"),required:!0,children:l.jsx(o,{style:{minWidth:200},value:I.treeLinkLibrary,placeholder:f("import.select_library"),onChange:t=>u(e,t),options:C})})]})]})})}const P=u.div`
    width: 100%;
    display: flex;
    flex-direction: column;
`;function F({libraries:e,onGetAttributes:a}){const{lang:u}=n(),{t:m}=t(),{state:y,dispatch:h}=k(),{sheets:x}=y,v=(e,t)=>{x[e]={...x[e],...t},h({type:j.SET_SHEETS,sheets:[...x]})},L=async(e,t)=>{const l=await a(t);v(e,{library:t,attributes:l,mapping:[],linkAttribute:null,keyToAttributes:null})},I=(e,t)=>{v(e,{type:t,linkAttribute:null,keyToAttributes:null})},C=(e,t)=>{v(e,{mode:t})},T=async(e,t)=>{var l;const i=x[e],r=i.attributes.find((e=>e.id===t)),n=r.type===g.tree?i.treeLinkLibrary:null==(l=null==r?void 0:r.linked_library)?void 0:l.id;let o=[];n&&(o=await a(n));const s=i.mapping;v(e,{linkAttribute:t,linkAttributeProps:r,mapping:s,keyToAttributes:o,treeLinkLibrary:r.type===g.tree&&r.linked_tree.libraries.map((e=>e.library.id)).includes(i.treeLinkLibrary)?i.treeLinkLibrary:null})},w=(e,t,l)=>{const i=x[e];let r=[...i.mapping];r[t]=l,r=r.map(((e,r)=>r!==t&&e===l&&i.keyToColumnIndex!==r&&i.keyToColumnIndex!==t?null:e)),v(e,{mapping:r})},O=async(e,t)=>{const l=t?await a(t):null;v(e,{treeLinkLibrary:t,keyToAttributes:l})},N=x.map(((t,n)=>{const a=t.type===b.IGNORE,h=t.data.slice(0,3),k=(e,t)=>({style:{verticalAlign:"top",background:t===h.length?i.secondaryBg:i.defaultBg}}),x=[{value:"import_key",label:l.jsxs(l.Fragment,{children:[l.jsx(_,{})," ",m("import.import_key")]})}];t.type===b.LINK&&x.push({value:"link_key",label:l.jsxs(l.Fragment,{children:[l.jsx(A,{})," ",m("import.link_key")]})});const j=Object.keys(t.data[0]).map(((e,t)=>({title:e,dataIndex:e,onCell:k})));j.unshift({title:l.jsx(l.Fragment,{}),dataIndex:"__root",onCell:k,width:"250px"});const f=h.map(((e,t)=>({...e,key:t})));if(t.type&&t.library&&(t.type!==b.LINK||t.linkAttribute)){const e={key:f.length,__root:l.jsx(E,{sheet:t}),...Object.keys(t.data[0]).reduce(((e,i,a)=>{var s;const d=(t.keyToColumnIndex===a?(null==t?void 0:t.keyToAttributes)??[]:((null==t?void 0:t.attributes)??[]).filter((e=>(null==e?void 0:e.type)===g.simple||(null==e?void 0:e.type)===g.advanced))).map((e=>({value:e.id,key:e.id,label:p(e.label,u)||e.id})));var c;return e[i]=l.jsxs(r,{direction:"vertical",style:{width:"100%"},children:[l.jsx(o,{style:{width:"100%"},placeholder:m("import.do_not_import"),value:null==(s=t.mapping)?void 0:s[a],allowClear:!0,onClear:()=>w(n,a,null),onSelect:e=>w(n,a,e),options:d}),l.jsx(S,{sheet:t,columnIndex:a,onChange:(c=a,(e,l)=>{const i={},r=t.mapping[c],a="key"===e?"keyTo":"key",o="key"===e?"keyColumnIndex":"keyToColumnIndex",s="key"===e?"keyToColumnIndex":"keyColumnIndex";i[e]=l?r:null,i[o]=l?c:null,t[s]===c&&(i[a]=null,i[s]=null),"keyTo"===e&&(i.mapping=[...t.mapping],i.mapping[c]=null),v(n,i)})})]}),e}),{})};f.push(e)}return{label:l.jsxs(r,{children:[t.name,!!y.settingsError[t.name]&&l.jsx(s,{style:{color:i.errorColor}})]}),key:String(n),children:l.jsxs(P,{children:[l.jsx(z,{sheetIndex:n,libraries:e,onLibrarySelect:L,onImportTypeSelect:I,onImportModeSelect:C,onLinkAttributeSelect:T,onTreeLinkLibrarySelect:O}),!a&&l.jsx(d,{title:()=>l.jsx(c.Title,{level:5,children:m("import.data_overview")}),columns:j,dataSource:f,size:"small",tableLayout:"auto",pagination:{hideOnSinglePage:!0},style:{width:"100%",overflow:"auto"}})]})}}));return l.jsx(f,{type:"card",items:N})}export{F as default};
