import{r as e,u as i,j as t}from"./useTranslation-e596755c.js";import{E as n,x as r,J as a,ad as o,a6 as s,aA as l,a9 as d,az as c,aB as h,ai as v,ak as u,a7 as p,P as g}from"./RecordCard-cc8b414d.js";import{n as m,ai as f,v as b,a$ as x,ab as y,J as j,b0 as w,l as C,ad as I,I as E,u as k,ac as L,c as $,a2 as _,Q as A,b1 as S,aq as M,as as V,d as T,U as R,a3 as D,aM as z,V as Q,a1 as N,E as B,e as O,b2 as F,a as H,b3 as P,W,s as q,f as G}from"./index-ba602e11.js";import{s as U}from"./styled-components.browser.esm-f2eded25.js";import{R as J,g as K,E as Y,S as X,G as Z,F as ee,U as ie,C as te,T as ne,a as re,b as ae,t as oe}from"./LibraryItemsList-344d0936.js";import{C as se,T as le}from"./utils-e6894fde.js";import{A as de,_ as ce,B as he,bg as ve,L as ue}from"./ImportReducerContext-32a848c6.js";import{P as pe}from"./index-4c873b97.js";import{D as ge,m as me}from"./progress-1d8d10a8.js";import"./index-39382eca.js";import"./index-b8ef5a18.js";import"./asyncToGenerator-2132afe6.js";import"./index-275ce878.js";const fe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M862 465.3h-81c-4.6 0-9 2-12.1 5.5L550 723.1V160c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8v563.1L255.1 470.8c-3-3.5-7.4-5.5-12.1-5.5h-81c-6.8 0-10.5 8.1-6 13.2L487.9 861a31.96 31.96 0 0048.3 0L868 478.5c4.5-5.2.8-13.2-6-13.2z"}}]},name:"arrow-down",theme:"outlined"};var be=function(i,t){return e.createElement(de,ce(ce({},i),{},{ref:t,icon:fe}))};be.displayName="ArrowDownOutlined";const xe=e.forwardRef(be);const ye={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M354 671h58.9c4.7 0 9.2-2.1 12.3-5.7L512 561.8l86.8 103.5c3 3.6 7.5 5.7 12.3 5.7H670c6.8 0 10.5-7.9 6.1-13.1L553.8 512l122.4-145.9c4.4-5.2.7-13.1-6.1-13.1h-58.9c-4.7 0-9.2 2.1-12.3 5.7L512 462.2l-86.8-103.5c-3-3.6-7.5-5.7-12.3-5.7H354c-6.8 0-10.5 7.9-6.1 13.1L470.2 512 347.9 657.9A7.95 7.95 0 00354 671z"}},{tag:"path",attrs:{d:"M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zm-40 728H184V184h656v656z"}}]},name:"close-square",theme:"outlined"};var je=function(i,t){return e.createElement(de,ce(ce({},i),{},{ref:t,icon:ye}))};je.displayName="CloseSquareOutlined";const we=e.forwardRef(je);const Ce={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M855 160.1l-189.2 23.5c-6.6.8-9.3 8.8-4.7 13.5l54.7 54.7-153.5 153.5a8.03 8.03 0 000 11.3l45.1 45.1c3.1 3.1 8.2 3.1 11.3 0l153.6-153.6 54.7 54.7a7.94 7.94 0 0013.5-4.7L863.9 169a7.9 7.9 0 00-8.9-8.9zM416.6 562.3a8.03 8.03 0 00-11.3 0L251.8 715.9l-54.7-54.7a7.94 7.94 0 00-13.5 4.7L160.1 855c-.6 5.2 3.7 9.5 8.9 8.9l189.2-23.5c6.6-.8 9.3-8.8 4.7-13.5l-54.7-54.7 153.6-153.6c3.1-3.1 3.1-8.2 0-11.3l-45.2-45z"}}]},name:"expand-alt",theme:"outlined"};var Ie=function(i,t){return e.createElement(de,ce(ce({},i),{},{ref:t,icon:Ce}))};Ie.displayName="ExpandAltOutlined";const Ee=e.forwardRef(Ie);const ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464h-68V240c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zM540 701v53c0 4.4-3.6 8-8 8h-40c-4.4 0-8-3.6-8-8v-53a48.01 48.01 0 1156 0zm152-237H332V240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v224z"}}]},name:"lock",theme:"filled"};var Le=function(i,t){return e.createElement(de,ce(ce({},i),{},{ref:t,icon:ke}))};Le.displayName="LockFilled";const $e=e.forwardRef(Le);const _e={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M920 760H336c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0-568H336c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H336c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM216 712H100c-2.2 0-4 1.8-4 4v34c0 2.2 1.8 4 4 4h72.4v20.5h-35.7c-2.2 0-4 1.8-4 4v34c0 2.2 1.8 4 4 4h35.7V838H100c-2.2 0-4 1.8-4 4v34c0 2.2 1.8 4 4 4h116c2.2 0 4-1.8 4-4V716c0-2.2-1.8-4-4-4zM100 188h38v120c0 2.2 1.8 4 4 4h40c2.2 0 4-1.8 4-4V152c0-4.4-3.6-8-8-8h-78c-2.2 0-4 1.8-4 4v36c0 2.2 1.8 4 4 4zm116 240H100c-2.2 0-4 1.8-4 4v36c0 2.2 1.8 4 4 4h68.4l-70.3 77.7a8.3 8.3 0 00-2.1 5.4V592c0 2.2 1.8 4 4 4h116c2.2 0 4-1.8 4-4v-36c0-2.2-1.8-4-4-4h-68.4l70.3-77.7a8.3 8.3 0 002.1-5.4V432c0-2.2-1.8-4-4-4z"}}]},name:"ordered-list",theme:"outlined"};var Ae=function(i,t){return e.createElement(de,ce(ce({},i),{},{ref:t,icon:_e}))};Ae.displayName="OrderedListOutlined";const Se=e.forwardRef(Ae),Me=n`
    ${m}
    subscription TREE_EVENTS($filters: TreeEventFiltersInput) {
        treeEvent(filters: $filters) {
            type
            treeId
            element {
                id
                childrenCount
                record {
                    ...RecordIdentity
                }
                permissions {
                    access_tree
                    detach
                    edit_children
                }
            }
            parentNode {
                id
            }
            parentNodeBefore {
                id
            }
        }
    }
`,Ve=U.div`
    position: relative;
    min-width: ${r.navigationColumnWidth};
    max-width: ${r.navigationColumnWidth};

    display: grid;
    justify-items: center;
    word-break: break-all;

    background: ${r.defaultBg};
    border-right: 1px solid ${r.borderLightColor};
    border-bottom: 1px solid ${r.borderLightColor};
    padding: 1rem;
    box-shadow: 0 1 1rem red;

    .header-detail {
        width: 100%;
    }
`,Te=U.div`
    display: flex;
    flex-flow: column nowrap;
    justify-content: start;
    gap: 0.5rem;
`,Re=U.div`
    span {
        font-weight: 600;
    }
`,De=U.div`
    padding: 2rem;
    width: 100%;
`,ze=U(se)`
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    font-size: 1.1em;
    cursor: pointer;
`,Qe=({treeElement:e,closable:n,onClose:r})=>{var a,o,s;const{t:l}=i(),d=e.record,c=null==(o=null==(a=null==d?void 0:d.whoAmI)?void 0:a.preview)?void 0:o.file,h=d.whoAmI.label?d.whoAmI.label:l("navigation.list.info.no-label"),v=null==(s=d.whoAmI.preview)?void 0:s.big;return t.jsxs(Ve,{"data-testid":"details-column",children:[n&&t.jsx(ze,{onClick:r}),t.jsx(De,{children:t.jsx(J,{previewFile:c,label:d.whoAmI.label?h:d.id,color:d.whoAmI.color,image:v&&f(v),tile:!0,placeholderStyle:{width:"10rem",height:"10rem"},imageStyle:{maxHeight:"15rem",maxWidth:"100%"}},d.id)}),t.jsxs(Te,{children:[t.jsxs(Re,{children:[t.jsxs("span",{children:[l("navigation.list.info.id"),":"]})," ",d.id]}),t.jsxs(Re,{children:[t.jsxs("span",{children:[l("navigation.list.info.label"),":"]})," ",h]})]})]})},Ne=U.img`
    transform: translate(0px, -1px) rotate(90deg);
`,Be=()=>t.jsx("div",{children:t.jsx(Ne,{src:x,alt:"icon ellipsis vertical"})}),Oe=a`
    mutation REMOVE_TREE_ELEMENT($treeId: ID!, $nodeId: ID!, $deleteChildren: Boolean) {
        treeDeleteElement(treeId: $treeId, nodeId: $nodeId, deleteChildren: $deleteChildren)
    }
`,Fe=e=>{const i=y();return{refreshTreeContent(){i.refetchQueries({updateCache:i=>{const t=i.extract();Object.keys(t.ROOT_QUERY).filter((i=>i.match(new RegExp(`treeNodeChildren(.*)${e}`)))).forEach((e=>i.evict({fieldName:e}))),i.gc()}})}}},He=a`
    mutation ADD_TREE_ELEMENT($treeId: ID!, $element: TreeElementInput!, $parent: ID, $order: Int) {
        treeAddElement(treeId: $treeId, element: $element, parent: $parent, order: $order) {
            id
        }
    }
`;function Pe({availableLibraries:n,parent:r,onMessages:a}){var l;const{t:d}=i(),{lang:c}=o(),[h]=j(He),[v]=w(),{refreshTreeContent:u}=Fe(v.id),[p,g]=e.useState(),[m,f]=e.useState(!1),b=e=>()=>{f(!0),g(e)},x=t.jsx(pe,{});return n.length?t.jsxs(t.Fragment,{children:[n.length>1?t.jsx(s,{menu:{items:n.map((e=>({key:e.library.id,onClick:b(e.library.id),label:C(e.library.label,c)})))},children:t.jsx(le,{title:d("navigation.header.add_by_creation"),placement:"top",children:t.jsx(he,{icon:x})})}):t.jsx(le,{title:d("navigation.header.add_by_creation"),placement:"top",children:t.jsx(he,{icon:x,"aria-label":"add-by-creation",onClick:b((null==(l=n[0])?void 0:l.library.id)??null)})}),m&&t.jsx(Y,{open:m,library:p,record:null,onClose:()=>f(!1),afterCreate:async e=>{var i,t;let n,o={countValid:0,errors:{}};try{await h({variables:{treeId:v.id,element:{id:e.id,library:e.library.id},parent:(null==r?void 0:r.id)??null}}),o={...o,countValid:1},n={channel:I.trigger,type:E.success,content:d("navigation.notifications.success-add",{nb:1})}}catch(s){if(s.graphQLErrors&&s.graphQLErrors.length){const e=null==(i=s.graphQLErrors[0].extensions.fields)?void 0:i.parent,n=null==(t=s.graphQLErrors[0].extensions.fields)?void 0:t.element;e&&(o.errors[e]=[...o.errors[e]??[]]),n&&(o.errors[n]=[...o.errors[n]??[]])}else n={channel:I.trigger,type:E.error,content:`${d("error.error_occurred")}: ${s.message}`}}a("navigation.infos.success-add","navigation.infos.error-add",o),u()}})]}):null}function We({availableLibraries:n,parent:r,onMessages:a}){const{t:l}=i(),{lang:d}=o(),[c,h]=e.useState(!1),[v,u]=e.useState(),[p]=w(),g=k(),{refreshTreeContent:m}=Fe(p.id),[f]=j(He),b=e=>{u(e),h(!0)},x=t.jsx(Z,{size:"1.2em"}),y={paddingTop:"5px"};return n.length?t.jsxs(t.Fragment,{children:[n.length>1?t.jsx(s,{menu:{items:n.map((e=>({key:e.library.id,onClick:()=>b(e.library.id),label:C(e.library.label,d)})))},children:t.jsx(le,{title:l("navigation.header.add_by_search"),placement:"top",children:t.jsx(he,{icon:x,style:y})})}):t.jsx(le,{title:l("navigation.header.add_by_search"),placement:"top",children:t.jsx(he,{icon:x,"aria-label":"add-by-search",onClick:()=>{var e;return b((null==(e=n[0])?void 0:e.library.id)??null)},style:y})}),c&&t.jsx(X,{visible:c,setVisible:h,submitAction:async e=>{var i,t;if(e.selected.length){let o={countValid:0,errors:{}};for(const a of e.selected){const e={id:a.id,library:a.library};try{await f({variables:{treeId:p.id,element:e,parent:(null==r?void 0:r.id)??null}}),o={...o,countValid:o.countValid+1}}catch(n){if(n.graphQLErrors&&n.graphQLErrors.length){const e=null==(i=n.graphQLErrors[0].extensions.fields)?void 0:i.parent,r=null==(t=n.graphQLErrors[0].extensions.fields)?void 0:t.element;e&&(o.errors[e]=[...o.errors[e]??[],a.id]),r&&(o.errors[r]=[...o.errors[r]??[],a.label||a.id])}else g(L({channel:I.trigger,type:E.error,content:`${l("error.error_occurred")}: ${n.message}`}))}}a("navigation.infos.success-add","navigation.infos.error-add",o),m()}},libId:v})]}):null}function qe({isDetail:n,parent:r,allowedChildrenLibraries:a,onMessages:o}){const{t:c}=i(),h=k(),{selectionState:v,navigation:u}=$((e=>({selectionState:e.selection,navigation:e.navigation}))),p=!!v.selection.selected.length,[g]=w(),[m,f]=e.useState(!1),[b,x]=e.useState(!1),[y,C]=e.useState(!1),[M,V]=e.useState(!1),[T]=j(Oe),{refreshTreeContent:R}=Fe(g.id),D=r?r.permissions.edit_children:g.permissions.edit_children,z=!!r&&r.permissions.detach,Q=[{key:"upload",icon:t.jsx(_,{}),onClick:()=>C(!0),label:c("upload.title"),displayCondition:g.behavior===ve.files&&(!r||(null==r?void 0:r.record.whoAmI.library.behavior)===ue.directories)},{key:"create_directory",icon:t.jsx(ee,{}),onClick:()=>V(!0),label:c("create_directory.title"),displayCondition:g.behavior===ve.files&&(!r||(null==r?void 0:r.record.whoAmI.library.behavior)===ue.directories)},{key:"details",icon:t.jsx(A,{}),onClick:()=>{const e=u.path.findIndex((e=>e.id===(null==r?void 0:r.id))),i=[...u.path];i[e]={...r,showDetails:!0},h(S(i))},label:c("navigation.actions.details"),displayCondition:!!r&&!n},{key:"edit",icon:t.jsx(Ee,{}),onClick:()=>x(!0),label:c("navigation.actions.edit"),displayCondition:!!r},{key:"classified_in",icon:t.jsx(l,{}),onClick:()=>me.warning(c("global.feature_not_available")),label:c("navigation.actions.classified_in"),displayCondition:!0},{label:c("files.generate_previews"),icon:t.jsx(d,{}),onClick:()=>{f(!0)},displayCondition:g.behavior===ve.files},{key:"divider",type:"divider",displayCondition:D},{key:"order",icon:t.jsx(Se,{}),onClick:()=>me.warning(c("global.feature_not_available")),label:c("navigation.actions.order"),displayCondition:D},{key:"detach",icon:t.jsx(ge,{}),onClick:async()=>{const e=r.record.whoAmI.label;let i;try{await T({variables:{treeId:g.id,nodeId:(null==r?void 0:r.id)??null}}),i={channel:I.trigger,type:E.success,content:c("navigation.infos.success-detach",{nb:1})}}catch(t){i={channel:I.trigger,type:E.error,content:c("navigation.infos.error-detach",{elementName:e??r.record.id,errorMessage:t.message})}}h(L(i)),R()},label:c("navigation.actions.detach"),displayCondition:D&&z}].reduce(((e,i)=>{if(i.displayCondition){const{displayCondition:t,...n}=i;e.push(n)}return e}),[]);return t.jsxs(t.Fragment,{children:[y&&t.jsx(ie,{defaultSelectedNode:{id:(null==r?void 0:r.id)||g.id,recordId:null==r?void 0:r.record.id},libraryId:g.libraries.filter((e=>e.behavior===ue.files))[0].id,multiple:!0,onClose:()=>C(!1),onCompleted:()=>{R()}}),M&&t.jsx(te,{defaultSelectedKey:(null==r?void 0:r.id)||g.id,libraryId:(null==r?void 0:r.record.whoAmI.library.id)||g.libraries.filter((e=>e.behavior===ue.directories))[0].id,onClose:()=>V(!1),onCompleted:()=>{R()}}),b&&t.jsx(Y,{open:b,library:r.record.whoAmI.library.id,record:r.record.whoAmI,onClose:()=>x(!1)}),!p&&t.jsxs(t.Fragment,{children:[D&&t.jsxs(t.Fragment,{children:[t.jsx(We,{availableLibraries:a,parent:r,onMessages:o}),t.jsx(Pe,{availableLibraries:a,parent:r,onMessages:o})]}),t.jsx("span",{"data-testid":"dropdown-tree-actions",children:t.jsx(s,{placement:"bottomRight",menu:{items:Q},children:t.jsx(he,{icon:t.jsx(Be,{})})})})]}),m&&t.jsx(ne,{libraryId:r.record.whoAmI.library.id,recordIds:[r.record.id],onClose:()=>{f(!1)}})]})}function Ge({allowedLibraries:e,parent:n,onMessages:r}){const{t:a}=i(),{selectionState:o}=$((e=>({selectionState:e.selection,navigation:e.navigation}))),s=k(),[l]=w(),[d]=j(He),{refreshTreeContent:c}=Fe(l.id);return o.selection.selected.some((i=>e.includes(i.library)))?t.jsx(he,{icon:t.jsx(pe,{}),onClick:async()=>{var i,t;if(o.selection.selected.length){let a={countValid:0,errors:{}};const s=(null==n?void 0:n.id)??null,v=o.selection.selected.filter((i=>e.includes(i.library)));for(const e of v){const n={id:e.id,library:e.library};try{await d({variables:{treeId:l.id,element:n,parent:s}}),a={...a,countValid:a.countValid+1}}catch(h){if(h.graphQLErrors&&h.graphQLErrors.length){const n=null==(i=h.graphQLErrors[0].extensions.fields)?void 0:i.parent,r=null==(t=h.graphQLErrors[0].extensions.fields)?void 0:t.element;n&&(a.errors[n]=[...a.errors[n]??[],e.id]),r&&(a.errors[r]=[...a.errors[r]??[],e.label||e.id])}}}r("navigation.infos.success-add","navigation.infos.error-add",a),c()}else{const e={channel:I.trigger,type:E.warning,content:a("navigation.infos.warning-add-no-selection")};s(L(e))}s(M())},"aria-label":"add-selection",title:a("navigation.actions.add-selected")}):null}function Ue({onMessages:e}){const{t:n}=i(),{selectionState:r,navigation:a}=$((e=>({selectionState:e.selection,navigation:e.navigation}))),o=k(),[s]=w(),[l]=j(Oe),{refreshTreeContent:d}=Fe(s.id);return t.jsx(he,{onClick:async()=>{var i,t;const n={countValid:0,errors:{}},c=[];for(const e of r.selection.selected)try{await l({variables:{treeId:s.id,nodeId:e.nodeId}}),n.countValid++,c.push(e.nodeId)}catch(v){if(v.graphQLErrors&&v.graphQLErrors.length){const r=null==(i=v.graphQLErrors[0].extensions.fields)?void 0:i.parent,a=null==(t=v.graphQLErrors[0].extensions.fields)?void 0:t.element;r&&(n.errors[r]=[...n.errors[r]??[],e.id]),a&&(n.errors[a]=[...n.errors[a]??[],e.label||e.id])}}d(),e("navigation.notifications.success-detach","navigation.notifications.error-detach",n),o(M());const h=a.path.filter((e=>!c.includes(e.id)));o(S(h))},"aria-label":"detach-selection",icon:t.jsx(ge,{}),title:n("navigation.actions.detach-selected")})}const Je=a`
    mutation MOVE_TREE_ELEMENT($treeId: ID!, $nodeId: ID!, $parentTo: ID, $order: Int) {
        treeMoveElement(treeId: $treeId, nodeId: $nodeId, parentTo: $parentTo, order: $order) {
            id
        }
    }
`;function Ke({allowedLibraries:e,parent:n,onMessages:r}){const{t:a}=i(),{selectionState:o}=$((e=>({selectionState:e.selection,navigation:e.navigation}))),s=k(),[l]=w(),[d]=j(Je),{refreshTreeContent:c}=Fe(l.id);return o.selection.selected.some((i=>e.includes(i.library)))?t.jsx(he,{onClick:async()=>{var i,t;const a={countValid:0,errors:{}},h=(null==n?void 0:n.id)??null,v=o.selection.selected.filter((i=>e.includes(i.library)));for(const e of v)try{await d({variables:{treeId:l.id,nodeId:e.nodeId,parentTo:h}}),a.countValid++}catch(u){if(u.graphQLErrors&&u.graphQLErrors.length){const n=null==(i=u.graphQLErrors[0].extensions.fields)?void 0:i.parent,r=null==(t=u.graphQLErrors[0].extensions.fields)?void 0:t.element;n&&(a.errors[n]=[...a.errors[n]??[],e.id]),r&&(a.errors[r]=[...a.errors[r]??[],e.label||e.id])}}c(),r("navigation.notifications.success-move","navigation.notifications.error-move",a),s(M())},icon:t.jsx(xe,{}),"aria-label":"move-selection",title:a("navigation.actions.move-selected")}):null}function Ye({parent:e,allowedChildrenLibraries:i,onMessages:n}){const{selectionState:r}=$((e=>({selectionState:e.selection,navigation:e.navigation}))),a=!!r.selection.selected.length,[o]=w(),s=r.selection.type===V.navigation,l=r.selection.type===V.navigation&&r.selection.parent===(null==e?void 0:e.id),d=e?e.permissions.edit_children:o.permissions.edit_children;return a?t.jsxs(t.Fragment,{children:[!l&&d&&t.jsx(Ge,{parent:e,allowedLibraries:i,onMessages:n}),s&&d&&!l&&t.jsx(Ke,{parent:e,allowedLibraries:i,onMessages:n}),s&&t.jsx(Ue,{onMessages:n})]}):null}function Xe({depth:e,isDetail:n}){const{t:r}=i(),a=$((e=>e.navigation)),o=k(),[s]=w(),l=e,d=a.path[l-1],{libraries:c}=((e,i)=>{var t,n,r;const{data:a,loading:o,error:s}=b(K,{skip:!e,variables:{treeId:e}}),l=[];if(!o&&!s){const e=(null==(n=null==(t=null==a?void 0:a.trees)?void 0:t.list[0])?void 0:n.libraries)??[];if(i){const t=e.find((e=>e.library.id===i.record.whoAmI.library.id)),n="__all__"===(null==(r=null==t?void 0:t.settings.allowedChildren)?void 0:r[0]);l.push(...e.filter((e=>n||t.settings.allowedChildren.includes(e.library.id))))}else l.push(...e.filter((e=>e.settings.allowedAtRoot)))}return{loading:o,error:s,libraries:l}})(null==s?void 0:s.id,d),h=c.map((e=>e.library.id)),v=(e,i,t)=>{if(t.countValid){const i={channel:I.trigger,type:E.success,content:r(e,{nb:t.countValid})};o(L(i))}delete t.countValid;const n=Object.keys(t.errors);for(const a of n){const e={channel:I.trigger,type:E.warning,content:r(i,{elements:t.errors[a].reduce(((e,i)=>e?`${e}, ${i}`:`${i}`),""),errorMessage:a})};o(L(e))}};return s?t.jsxs(he.Group,{style:{height:"30px"},children:[t.jsx(Ye,{parent:d,allowedChildrenLibraries:h,onMessages:v}),t.jsx(qe,{parent:d,isDetail:n,allowedChildrenLibraries:c,onMessages:v})]}):null}const Ze=U.header`
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: ${r.secondaryBg};
    height: 4rem;
    flex-shrink: 0;
    cursor: pointer;
    max-width: ${r.navigationColumnWidth};

    &:not(:hover) .select-all-checkbox {
        visibility: hidden;
    }
`;function ei({depth:e,isDetail:n,isActive:r,treeElement:a,children:o}){const{t:s}=i(),{navigation:l,selectionState:d}=$((e=>({navigation:e.navigation,selectionState:e.selection}))),v=k(),u=e,[p]=w(),g=d.selection.selected.length,m=l.path[u-1],f=(null==a?void 0:a.record)?a.record.whoAmI.label||a.record.id:(null==p?void 0:p.label)||(null==p?void 0:p.id);return t.jsxs(Ze,{onClick:()=>{r||v(S(m?l.path.slice(0,u):[]))},isActive:r,children:[g&&r?t.jsxs(le,{title:s("navigation.header.nb-selection",{nb:g,selectionType:s(`search.type.${V[d.selection.type]}`)}),placement:"right",children:[s("navigation.header.selection_label",{count:g}),t.jsx(he,{icon:t.jsx(we,{}),"aria-label":"clear-selection",onClick:()=>{v(M())},style:{border:"none",color:"#000"},ghost:!0})]}):t.jsxs(t.Fragment,{children:[r&&!!(null==a?void 0:a.childrenCount)&&t.jsx(c,{className:"select-all-checkbox",onClick:()=>{const e=o.filter((e=>e.permissions.access_tree)).map((e=>({id:e.record.whoAmI.id,nodeId:e.id,library:e.record.whoAmI.library.id,label:e.record.whoAmI.label})));v(T({type:V.navigation,selected:e,parent:(null==a?void 0:a.id)??null}))}}),t.jsx(h,{ellipsis:{tooltip:f,rows:1},style:{marginBottom:0,marginRight:".5em"},children:f})]}),r&&t.jsx(Xe,{depth:e,isDetail:n})]})}const ii=U.div`
    position: relative;
    display: grid;

    place-items: flex-start;
    align-items: center;
    max-width: ${r.navigationColumnWidth};
    overflow: hidden;

    grid-template-columns: ${e=>((e,i)=>{let t=[];return e&&(t=["1rem"]),i||(t=[...t,"1rem"]),t=[...t,"auto","auto","1rem"],t.join(" ")})(e.isActive,e.isRecordActive)};
    padding: 1rem 0.5rem;
    background: ${e=>e.isInPath?r.activeColor:"none"};

    &:hover {
        ${e=>e.isInPath?"":`background: ${r.activeColor}`};

        .checkbox-wrapper {
            opacity: 1;
        }
    }

    .counter {
        justify-self: flex-end;
    }

    :not(:hover) .floating-menu {
        display: none;
    }
`,ti=U.div`
    min-width: 0;
    width: 100%;
    padding-right: 0.2rem;

    & > * > * {
        justify-content: space-around;
    }
`,ni=U.div`
    opacity: ${({selectionActive:e})=>e?1:0};
    transition: 100ms ease;

    :hover {
        opacity: 1;
    }
`;function ri({isActive:n,treeElement:a,depth:s}){const{lang:c}=o(),{t:h}=i(),{selectionState:g,navigation:m}=$((e=>({selectionState:e.selection,navigation:e.navigation}))),f=k(),[b,x]=e.useState(!1),y=m.path[s-1],j=a.record.whoAmI.label,w=a.permissions.access_tree,I={...a.record.whoAmI,label:j??""},E=m.path.some((e=>e.id===a.id)),L=g.selection.selected.some((e=>e.nodeId===a.id)),_=a.record.active,M="middle",Q=[{title:h("global.details"),button:t.jsx(re,{shape:"circle",record:I,size:M})}],N=w?[{title:h("navigation.actions.details"),icon:t.jsx(A,{}),onClick:()=>{const e=[...m.path.slice(0,s),{...a,showDetails:!0}];f(S(e))}},{title:h("navigation.actions.classified_in"),icon:t.jsx(l,{}),onClick:()=>me.warning(h("global.feature_not_available"))},{title:h("files.generate_previews"),icon:t.jsx(d,{}),onClick:()=>{x(!0)}}]:[];return t.jsxs(ii,{onClick:()=>{if(!w)return;const e=[...m.path.slice(0,s),{...a}];f(S(e))},isInPath:E,isActive:n,isRecordActive:_,children:[t.jsx(R,{actions:Q,moreActions:N,style:{right:"15px"},size:M}),!w&&t.jsx(le,{title:h("navigation.access_denied"),children:t.jsx($e,{})}),n&&w&&t.jsx(ni,{onClick:e=>{e.preventDefault(),e.stopPropagation()},className:"checkbox-wrapper",selectionActive:!!g.selection.selected.length,children:t.jsx(ae,{onClick:e=>{e.preventDefault(),e.stopPropagation();if(g.selection.selected.find((e=>e.nodeId===a.id))){const e=g.selection.selected.filter((e=>e.nodeId!==a.id)),i={type:V.navigation,selected:e,parent:null==y?void 0:y.id};f(T(i))}else{const e=C(a.record.whoAmI.label,c),i={id:a.record.whoAmI.id,nodeId:a.id,library:a.record.whoAmI.library.id,label:e};let t=[i];g.selection.type===V.navigation&&(null==y?void 0:y.id)===g.selection.parent&&(t=[...g.selection.selected,i]);const n={type:V.navigation,selected:t,parent:null==y?void 0:y.id};f(T(n))}},checked:L})}),!_&&t.jsx(le,{title:h("navigation.inactive_element"),children:t.jsx(v,{style:{color:r.errorColor,fontSize:"1.3em",marginLeft:"0.5rem"}})}),t.jsx(ti,{children:t.jsx(u,{record:I,size:D.small})}),!!a.childrenCount&&t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"counter",children:t.jsx(z,{count:a.childrenCount,overflowCount:1e3,style:{background:r.secondaryBg,color:r.defaultTextColor}})}),t.jsx("div",{children:w&&t.jsx(p,{})})]}),b&&t.jsx(ne,{libraryId:I.library.id,recordIds:[I.id],onClose:()=>{x(!1)}})]})}const ai=U.div`
    border-right: 1px solid ${r.borderLightColor};
    width: ${r.navigationColumnWidth};
    height: 100%;
    display: flex;
    flex-flow: column nowrap;
    flex-shrink: 0;

    background: ${r.defaultBg};
`,oi=U.div`
    overflow-y: auto;
    height: 100%;
`,si=U(g)`
    && {
        text-align: center;
        padding: 0.5em 0;
        border-bottom: 1px solid ${r.borderColor};
    }
`,li=({treeElement:i,depth:n,isActive:r})=>{const[a]=w(),[o,s]=e.useState(1),[l,d]=e.useState(0),c=k(),{navigation:h}=$((e=>({navigation:e.navigation}))),v={treeId:null==a?void 0:a.id,node:(null==i?void 0:i.id)??null,pagination:{limit:Q,offset:(o-1)*Q}},{loading:u,error:p,data:g,refetch:m,called:f}=b(oe,{variables:v,onCompleted:e=>{d(e.treeNodeChildren.totalCount)},skip:!a});N(Me,{variables:{filters:{ignoreOwnEvents:!0,treeId:null==a?void 0:a.id,nodes:[(null==i?void 0:i.id)??null]}},skip:!(null==a?void 0:a.id)||u,onSubscriptionData(){m(v)}});const x=e.createRef();e.useEffect((()=>{var e,i;(null==(e=null==x?void 0:x.current)?void 0:e.scrollIntoView)&&r&&(null==(i=x.current)||i.scrollIntoView({behavior:"smooth",block:"end"}))}),[x,r]),e.useEffect((()=>{a&&f&&m(v)}),[o]);const y=(null==g?void 0:g.treeNodeChildren.list)??[],j=!p,C=i&&(!u&&!l||i.showDetails);return t.jsxs(ai,{ref:x,"data-testid":"navigation-column"+(C?"-with-details":""),showDetails:C,children:[t.jsx(ei,{depth:n,treeElement:i,isActive:r,isDetail:C,children:y}),p&&t.jsx(B,{message:p.message}),j&&C&&t.jsx(Qe,{treeElement:i,closable:!!(null==i?void 0:i.childrenCount),onClose:()=>{const e=h.path.findIndex((e=>e.id===(null==i?void 0:i.id))),t=[...h.path];t[e]={...i,showDetails:!1},c(S(t))}}),j&&t.jsxs(t.Fragment,{children:[l>Q&&t.jsx(si,{simple:!0,current:o,total:l,onChange:e=>{s(e)},pageSize:Q}),u?t.jsx(O,{}):t.jsx(oi,{children:y.map((e=>t.jsx(ri,{treeElement:e,depth:n,isActive:r},e.id)))})]})]})},di=U.div`
    width: auto;
    height: calc(100vh - 3rem);
    display: flex;
    flex-flow: row nowrap;
    overflow-x: scroll;
    overflow-y: hidden;
`;function ci({tree:i}){const n=$((e=>e.navigation)),r=k();e.useEffect((()=>{r(F(i))}),[i,r]);const a=0===n.path.length;return t.jsxs(di,{children:[t.jsx(li,{treeElement:null,depth:0,isActive:a},"__root__"),n.path.map(((e,i)=>t.jsx(li,{treeElement:e,depth:i+1,isActive:i===n.path.length-1},`${e.record.id}`)))]})}function hi({tree:n}){var r,a;const{t:s}=i(),l=H(),d=k(),{activePanel:c}=$((e=>e)),{lang:h}=o(),[v,u]=w(),{data:p,loading:g,error:m}=P({onlyAllowed:!1,treeId:n,skip:!n}),f=null==(a=null==(r=null==p?void 0:p.trees)?void 0:r.list[0])?void 0:a.permissions.access_tree;return e.useEffect((()=>{var e;if(c!==W.TREE||!f)return;const i=null==(e=null==p?void 0:p.trees)?void 0:e.list[0];if(!g&&i){const e=C(i.label,h);u({id:i.id,label:e,behavior:i.behavior,libraries:i.libraries.map((e=>({id:e.library.id,behavior:e.library.behavior}))),permissions:i.permissions});const t={content:s("info.active-tree",{tree:e,appLabel:C(l.currentApp.label,h),interpolation:{escapeValue:!1}}),type:E.basic};d(q(t))}}),[p,g,h,u,s,d,c,v,n,f]),g?t.jsx(O,{}):m?t.jsx(B,{message:m.message}):f?t.jsx(ci,{tree:n}):t.jsx(B,{type:G.PERMISSION_ERROR})}export{hi as default};
